/**
 * –ë–ê–ù–ö–û–í–°–ö–ò–ô –†–û–ë–û–¢-–†–ê–ó–ú–ï–¢–ß–ò–ö v1.0 (STABLE)
 * –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∏–ø–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
 * –≤ —Å–µ—Ä–≤–∏—Å–µ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –¥–ª—è –ê–£–°–ù –î–æ—Ö–æ–¥—ã-–†–∞—Å—Ö–æ–¥—ã.
 * –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ "–ö–æ–º–∏—Å—Å–∏—è" –∏ –†–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ –±–∞–Ω–∫–æ–º –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫
 * –†–∞—Å—Ö–æ–¥—ã - –ö–æ–º–∏—Å—Å–∏—è –∑–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥
 * –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–µ–∫—Å—Ç–æ–º "–í–æ–∑–º" –∏ –†–∞–∑–º–µ—á–µ–Ω–Ω—ã–µ –±–∞–Ω–∫–æ–º –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫
 * –ù–µ–æ–±–ª–∞–≥–∞–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è - –≠–∫–≤–∞–π—Ä–∏–Ω–≥
 */
(async function stableOperationBot() {
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    
    // UI: –ö–Ω–æ–ø–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    let isRunning = true;
    const stopBtn = document.createElement('button');
    stopBtn.innerHTML = 'üõë STOP BOT';
    stopBtn.style = 'position:fixed;top:10px;right:10px;z-index:99999;padding:12px;background:#e74c3c;color:white;border:none;cursor:pointer;font-weight:bold;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.3);font-family:sans-serif;';
    stopBtn.onclick = () => { isRunning = false; stopBtn.innerHTML = '‚åõ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Å—å...'; };
    document.body.appendChild(stopBtn);

    const smartClick = (el) => {
        if (!el) return;
        const event = new MouseEvent('click', { view: window, bubbles: true, cancelable: true });
        el.dispatchEvent(event);
    };

    // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–≤—ã–º —É–∑–ª–∞–º (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∏–∫–æ–Ω–∫–∏ –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –º—É—Å–æ—Ä)
    const findExactOption = (targetText) => {
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const candidates = [];
        while (node = walker.nextNode()) {
            if (node.textContent.trim() === targetText) {
                const parent = node.parentElement;
                if (parent && parent.offsetWidth > 0 && parent.offsetHeight > 0) candidates.push(parent);
            }
        }
        return candidates[candidates.length - 1];
    };

    console.log('%c[v1.0 STABLE] –†–æ–±–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é DOM...', 'color: #2ecc71; font-weight: bold; font-size: 14px;');

    while (isRunning) {
        // –ü–æ–∏—Å–∫ —Ü–µ–ª–µ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        const targetCard = Array.from(document.querySelectorAll('.operations-history-table-transaction'))
            .find(card => {
                const markup = card.querySelector('.operations-history-table-transaction__markup')?.textContent || "";
                const title = card.querySelector('.operations-history-table-transaction__header-title')?.textContent || "";
                const currentType = card.querySelector('[data-test-id="operation-type"]')?.textContent.trim() || "";

                const isCorrectStatus = markup.includes('–†–ê–ó–ú–ï–ß–ï–ù–û –ë–ê–ù–ö–û–ú') || markup.includes('–ò–ó–ú–ï–ù–ï–ù–û –í–†–£–ß–ù–£–Æ');
                const isTargetItem = title.includes('–ö–æ–º–∏—Å—Å–∏—è') || title.includes('–í–æ–∑–º');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∏-–∏—Å–∫–ª—é—á–µ–Ω–∏—è
                const alreadyDone = currentType === '–ù–µ–æ–±–ª–∞–≥–∞–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è' && title.includes('–í–æ–∑–º');
                const isExpense = currentType === '–†–∞—Å—Ö–æ–¥' && title.includes('–í–æ–∑–º');

                return isCorrectStatus && isTargetItem && !alreadyDone && !isExpense && card.offsetWidth > 0;
            });

        if (!targetCard) {
            console.log('%c[FINISH] –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã.', 'color: #2ecc71; font-weight: bold');
            break;
        }

        const titleText = targetCard.querySelector('.operations-history-table-transaction__header-title').textContent;
        const isCommission = titleText.includes('–ö–æ–º–∏—Å—Å–∏—è');
        
        const config = isCommission 
            ? { type: '–†–∞—Å—Ö–æ–¥', category: '–ö–æ–º–∏—Å—Å–∏—è –∑–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥' }
            : { type: '–ù–µ–æ–±–ª–∞–≥–∞–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è', category: '–≠–∫–≤–∞–π—Ä–∏–Ω–≥' };

        try {
            targetCard.scrollIntoView({ block: 'center', behavior: 'smooth' });
            await sleep(500);

            const editBtn = targetCard.querySelector('.operations-history-table-transaction__transaction-edit-btn');
            if (!editBtn) continue;

            console.log(`%c[PROCESS] ${isCommission ? '–ö–æ–º–∏—Å—Å–∏—è' : '–í–æ–∑–º–µ—â–µ–Ω–∏–µ'} -> ${config.type}`, 'color: #3498db');
            smartClick(editBtn);
            await sleep(2000); // –û–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

            // 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¢–∏–ø–∞
            const typeField = document.querySelector('[data-test-id="operation-type-select-field"]');
            if (typeField) {
                smartClick(typeField);
                await sleep(800);
                const opt = findExactOption(config.type);
                if (opt) {
                    smartClick(opt);
                    await sleep(1500); // –ñ–¥–µ–º –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                }
            }

            // 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            const catField = document.querySelector('[data-test-id="operation-category-select-field"]');
            if (catField) {
                smartClick(catField);
                await sleep(1000);
                const opt = findExactOption(config.category);
                if (opt) {
                    smartClick(opt);
                    await sleep(800);
                } else {
                    console.warn(`[WARN] –ö–∞—Ç–µ–≥–æ—Ä–∏—è "${config.category}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–ø—É—Å–∫.`);
                    smartClick(catField); // –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                }
            }

            // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            const saveBtn = findExactOption('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
            if (saveBtn) {
                smartClick(saveBtn);
                console.log('%c[OK] –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'color: #2ecc71');
                await sleep(4000); // –¢–∞–π–º-–∞—É—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Backend-Frontend
            } else {
                window.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape' }));
                await sleep(1500);
            }

        } catch (err) {
            console.error('[ERROR] –û—à–∏–±–∫–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏:', err.message);
            window.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape' }));
            await sleep(2000);
        }
    }

    stopBtn.remove();
    console.log('%c[TERMINATED] –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.', 'color: #e74c3c; font-weight: bold');
})();
