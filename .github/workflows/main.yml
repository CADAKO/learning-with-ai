# .github/workflows/main.yml

name: QA Database Integration Tests

on:
  push:
    branches:
      - main # Запускать этот пайплайн при коммите в ветку main

jobs:
  run-db-tests:
    runs-on: ubuntu-latest # Использовать свежую виртуальную машину Ubuntu

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4 # 1. Получить код из репозитория

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9' # 2. Установить Python 3.9

    - name: Install Allure CLI (on the VM)
      run: |
        # Allure CLI нужен на виртуальной машине для генерации отчета
        sudo apt-get install allure

    - name: Install Python dependencies
      run: |
        # Устанавливаем зависимости проекта (pytest, requests, allure-pytest, psycopg2)
        pip install --no-cache-dir -r qa_db_project/requirements.txt
        # Устанавливаем зависимости API тоже (хотя они нужны только внутри Docker)
        pip install --no-cache-dir -r qa_db_project/api/requirements.txt

    - name: Prepare Allure Results Directory
      run: |
        mkdir -p allure-results

    - name: Run Tests with Docker Compose
      run: |
        # Запускаем скрипт, который мы написали ранее.
        # Он использует docker-compose run, чтобы запустить db и tests.
        python run_tests.py
      # Если этот шаг завершится неудачно, пайплайн остановится с ошибкой.

    - name: Generate Allure Report and Open (Skip in CI)
      run: |
        # В CI/CD мы не можем "открыть" отчет в браузере виртуальной машины,
        # поэтому мы просто генерируем его без открытия.
        allure generate allure-results --clean -o allure-report
      # Мы можем загрузить этот артефакт в GitHub, чтобы вы могли его посмотреть позже:

    - name: Upload Allure Report as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report
