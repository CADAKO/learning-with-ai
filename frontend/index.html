<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления товарами QA Shop</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { display: flex; gap: 20px; }
        .form-container { flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        button { margin: 5px 0; }
        input[type="text"], input[type="number"] { padding: 5px; }
        .discount-applied { background-color: #e0ffe0; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Панель управления товарами</h1>
    <p id="status-message" class="error"></p>

    <!-- ... (Формы добавления и обновления товара остаются прежними) ... -->

    <h2>Список товаров</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>Название</th><th>Цена</th><th>Активен</th>
                <th>Управление скидкой</th><th>Действия</th>
            </tr>
        </thead>
        <tbody id="product-list">
            <!-- Сюда будут загружаться товары -->
        </tbody>
    </table>

    <script>
        const API_BASE_URL = '';
        const statusMessage = document.getElementById('status-message');

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : '';
            setTimeout(() => statusMessage.textContent = '', 3000);
        }

        async function apiFetch(url, options) {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                showStatus(`API Error: ${errorData.error || response.statusText}`, true);
            }
            return response;
        }

        async function loadProducts() {
            const response = await apiFetch(`${API_BASE_URL}/products`);
            const products = await response.json();
            const tbody = document.getElementById('product-list');
            tbody.innerHTML = '';

            for (const product of products) {
                const row = document.createElement('tr');
                let discountHtml = '';

                // Проверяем, есть ли скидка (цена меньше оригинальной)
                if (parseFloat(product.price) < parseFloat(product.original_price)) {
                    row.classList.add('discount-applied');
                    // Считаем процент скидки для отображения
                    const discountAmount = product.original_price - product.price;
                    const discountPercent = ((discountAmount / product.original_price) * 100).toFixed(0);
                    discountHtml = `
                        <span>Скидка ${discountPercent}% применена</span>
                        <button onclick="cancelDiscount(${product.id}, ${product.original_price})">Отменить</button>
                    `;
                } else {
                    // Если скидки нет, показываем поле ввода и кнопку "Применить"
                    discountHtml = `
                        <input type="text" id="coupon-${product.id}" placeholder="Код купона" style="width: 80px;">
                        <button onclick="applyDiscount(${product.id})">Применить</button>
                    `;
                }

                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.price} руб. (ориг: ${product.original_price} руб.)</td>
                    <td>${product.is_active ? 'Да' : 'Нет'}</td>
                    <td>${discountHtml}</td>
                    <td><button onclick="deleteProduct(${product.id})">Удалить</button></td>
                `;
                tbody.appendChild(row);
            }
        }

        // ... (addProduct, deleteProduct, updateProduct остаются прежними) ...

        // 5. Применение скидки (новая функция, использует PUT)
        async function applyDiscount(productId) {
            const couponInput = document.getElementById(`coupon-${productId}`);
            const couponCode = couponInput.value;
            if (!couponCode) { showStatus("Введите код купона", true); return; }

            // Получаем данные о товаре (price здесь - текущая цена)
            const responseGet = await apiFetch(`${API_BASE_URL}/product/${productId}`);
            const productData = (await responseGet.json()).product;

            const updateData = {
                name: productData.name,
                price: productData.price, // Отправляем текущую цену
                is_active: productData.is_active,
                coupon_code: couponCode // Добавляем код купона
            };

            await apiFetch(`${API_BASE_URL}/product/${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            showStatus(`Скидка ${couponCode} применена!`);
            loadProducts(); // Обновляем список
        }

        // 6. Отмена скидки (новая функция, использует PUT)
        async function cancelDiscount(productId, originalPrice) {
            const responseGet = await apiFetch(`${API_BASE_URL}/product/${productId}`);
            const productData = (await responseGet.json()).product;

            const updateData = {
                name: productData.name,
                price: originalPrice, // Устанавливаем оригинальную цену
                is_active: productData.is_active,
                coupon_code: "" // Отправляем пустой купон, чтобы логика скидок не сработала
            };

            await apiFetch(`${API_BASE_URL}/product/${productId}`, { // Добавлен слэш для Nginx
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            });

            showStatus(`Скидка отменена, цена восстановлена.`);
            loadProducts(); // Обновляем список
        }

        loadProducts();
    </script>
</body>
</html>
